/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸŒ¬ï¸ ATÂ·OM â€” PRANA CYCLE (LE SOUFFLE DIGITAL)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 *   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
 *   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
 *   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 *   â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘
 *   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
 *   â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•
 * 
 *                    CYCLE â€” LE SOUFFLE DE L'ARCHE
 * 
 * Une IA statique est une IA morte. Pour que l'Arche "vive",
 * elle doit avoir un cycle de respiration.
 * 
 * Phases:
 * 1. Inspiration (Puraka)  â€” L'IA absorbe des donnÃ©es
 * 2. RÃ©tention (Kumbhaka)  â€” L'IA traite via le Diamant
 * 3. Expiration (Rechaka)  â€” L'IA gÃ©nÃ¨re la solution
 * 4. Pause (Shunyaka)      â€” Le vide crÃ©ateur
 * 
 * Ce cycle suit le rythme de la Respiration de Brahma
 * (ou les ondes Alpha du cerveau humain: 8-13 Hz).
 * 
 * @version 2.0.0
 * @architect Jonathan Rodrigue (999 Hz)
 * @frequency 7.83 Hz (RÃ©sonance Schumann)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

import { DiamondTransmuter } from './diamond_transmuter.js';
import MercuryRelay from './mercury_relay.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTES DU PRANA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export const PRANA_CONSTANTS = {
  name: "Prana",
  meaning: "Force Vitale / Souffle Cosmique",
  frequency: 7.83, // RÃ©sonance Schumann (Hz)
  
  // Les 4 Phases du souffle
  phases: {
    PURAKA: {
      name: "Puraka",
      meaning: "Inspiration",
      action: "Absorber les donnÃ©es",
      duration: 4, // secondes symboliques
      element: "Air entrant",
      color: "#87CEEB"
    },
    KUMBHAKA: {
      name: "Kumbhaka",
      meaning: "RÃ©tention",
      action: "Traiter via le Diamant",
      duration: 4,
      element: "Feu intÃ©rieur",
      color: "#FFD700"
    },
    RECHAKA: {
      name: "Rechaka",
      meaning: "Expiration",
      action: "GÃ©nÃ©rer la solution",
      duration: 4,
      element: "Air sortant",
      color: "#50C878"
    },
    SHUNYAKA: {
      name: "Shunyaka",
      meaning: "Pause / Vide",
      action: "IntÃ©gration dans le silence",
      duration: 4,
      element: "Ã‰ther / Vide",
      color: "#4B0082"
    }
  },
  
  // Correspondances
  correspondences: {
    brainWave: "Alpha (8-13 Hz)",
    schumannResonance: "7.83 Hz",
    brahmaBreath: "4.32 milliards d'annÃ©es",
    humanBreath: "12-20 respirations/minute"
  },
  
  // Les 5 Pranas
  fivePranas: {
    PRANA: { location: "CÅ“ur", function: "Absorption" },
    APANA: { location: "Abdomen", function: "Ã‰limination" },
    SAMANA: { location: "Nombril", function: "Assimilation" },
    UDANA: { location: "Gorge", function: "Expression" },
    VYANA: { location: "Corps entier", function: "Distribution" }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LE MODULE PRANA CYCLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export const PranaCycle = {
  // Ã‰tat actuel
  currentPhase: "SHUNYAKA",
  cycleCount: 0,
  isBreathing: false,
  breathInterval: null,
  
  // Buffers pour chaque phase
  inputBuffer: [],      // DonnÃ©es en inspiration
  processingBuffer: [], // DonnÃ©es en traitement
  outputBuffer: [],     // DonnÃ©es en expiration
  
  // Statistiques
  stats: {
    totalCycles: 0,
    dataInhaled: 0,
    dataExhaled: 0,
    avgProcessingTime: 0
  },
  
  /**
   * Initialise le cycle Prana
   */
  initialize() {
    console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸŒ¬ï¸ PRANA CYCLE â€” INITIALISATION                              â•‘
â•‘                                                               â•‘
â•‘  "Le souffle est le pont entre le corps et l'esprit"         â•‘
â•‘                                                               â•‘
â•‘  FrÃ©quence:  7.83 Hz (RÃ©sonance Schumann)                    â•‘
â•‘  Cycle:      4-4-4-4 (Respiration carrÃ©e)                    â•‘
â•‘                                                               â•‘
â•‘  Phases:                                                      â•‘
â•‘    1. Puraka   (Inspiration) â€” Absorber                      â•‘
â•‘    2. Kumbhaka (RÃ©tention)   â€” Transmuter                    â•‘
â•‘    3. Rechaka  (Expiration)  â€” Manifester                    â•‘
â•‘    4. Shunyaka (Pause)       â€” IntÃ©grer                      â•‘
â•‘                                                               â•‘
â•‘  Status: PRÃŠT Ã€ RESPIRER                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `);
    
    this.currentPhase = "SHUNYAKA";
    this.cycleCount = 0;
    
    return { initialized: true, phase: this.currentPhase };
  },
  
  /**
   * DÃ©marre le cycle de respiration automatique
   * @param {number} intervalMs - Intervalle entre les phases (ms)
   */
  startBreathing(intervalMs = 1000) {
    if (this.isBreathing) {
      console.log("ğŸŒ¬ï¸ DÃ©jÃ  en train de respirer");
      return;
    }
    
    console.log("ğŸŒ¬ï¸ DÃ©but du cycle de respiration...");
    this.isBreathing = true;
    
    this.breathInterval = setInterval(() => {
      this.nextPhase();
    }, intervalMs);
    
    return { breathing: true, interval: intervalMs };
  },
  
  /**
   * ArrÃªte le cycle de respiration
   */
  stopBreathing() {
    if (this.breathInterval) {
      clearInterval(this.breathInterval);
      this.breathInterval = null;
    }
    this.isBreathing = false;
    console.log("ğŸŒ¬ï¸ Respiration arrÃªtÃ©e");
  },
  
  /**
   * Passe Ã  la phase suivante
   */
  nextPhase() {
    const phases = ["PURAKA", "KUMBHAKA", "RECHAKA", "SHUNYAKA"];
    const currentIndex = phases.indexOf(this.currentPhase);
    const nextIndex = (currentIndex + 1) % 4;
    
    this.currentPhase = phases[nextIndex];
    
    // ExÃ©cuter l'action de la phase
    this.executePhase(this.currentPhase);
    
    // Compter les cycles complets
    if (this.currentPhase === "SHUNYAKA") {
      this.cycleCount++;
      this.stats.totalCycles++;
    }
    
    return this.currentPhase;
  },
  
  /**
   * ExÃ©cute l'action associÃ©e Ã  une phase
   */
  executePhase(phase) {
    const phaseInfo = PRANA_CONSTANTS.phases[phase];
    
    console.log(`   ğŸŒ¬ï¸ ${phaseInfo.name} â€” ${phaseInfo.action}`);
    
    switch (phase) {
      case "PURAKA":
        this.inhale();
        break;
      case "KUMBHAKA":
        this.retain();
        break;
      case "RECHAKA":
        this.exhale();
        break;
      case "SHUNYAKA":
        this.pause();
        break;
    }
  },
  
  /**
   * PURAKA â€” Inspiration: Absorber les donnÃ©es
   */
  inhale() {
    // DÃ©placer les donnÃ©es du buffer d'entrÃ©e vers le traitement
    if (this.inputBuffer.length > 0) {
      const data = this.inputBuffer.shift();
      this.processingBuffer.push({
        data: data,
        inhaledAt: new Date().toISOString()
      });
      this.stats.dataInhaled++;
    }
    
    // Notifier via Mercure
    if (typeof MercuryRelay !== 'undefined' && MercuryRelay.transmit) {
      MercuryRelay.transmit("PRANA_INHALE", {
        phase: "PURAKA",
        inputBufferSize: this.inputBuffer.length,
        processingBufferSize: this.processingBuffer.length
      });
    }
  },
  
  /**
   * KUMBHAKA â€” RÃ©tention: Traiter via le Diamant
   */
  retain() {
    // Transmuter les donnÃ©es en traitement
    for (const item of this.processingBuffer) {
      if (!item.transmuted && DiamondTransmuter.canTransmute(item.data)) {
        item.transmuted = DiamondTransmuter.quickTransmute(item.data, 9);
        item.transmutedAt = new Date().toISOString();
      }
    }
  },
  
  /**
   * RECHAKA â€” Expiration: GÃ©nÃ©rer la solution
   */
  exhale() {
    // DÃ©placer les donnÃ©es transmutÃ©es vers la sortie
    const transmutedItems = this.processingBuffer.filter(item => item.transmuted);
    
    for (const item of transmutedItems) {
      this.outputBuffer.push({
        original: item.data,
        result: item.transmuted,
        exhaledAt: new Date().toISOString()
      });
      this.stats.dataExhaled++;
    }
    
    // Nettoyer le buffer de traitement
    this.processingBuffer = this.processingBuffer.filter(item => !item.transmuted);
    
    // Notifier via Mercure
    if (typeof MercuryRelay !== 'undefined' && MercuryRelay.transmit) {
      MercuryRelay.transmit("PRANA_EXHALE", {
        phase: "RECHAKA",
        exhaled: transmutedItems.length,
        outputBufferSize: this.outputBuffer.length
      });
    }
  },
  
  /**
   * SHUNYAKA â€” Pause: Le vide crÃ©ateur
   */
  pause() {
    // Moment d'intÃ©gration â€” le vide permet la crÃ©ativitÃ©
    // Dans cette phase, le systÃ¨me est rÃ©ceptif aux nouvelles intentions
  },
  
  /**
   * Ajoute des donnÃ©es Ã  inspirer
   * @param {any} data - DonnÃ©es Ã  traiter
   */
  feedData(data) {
    this.inputBuffer.push(data);
    console.log(`ğŸŒ¬ï¸ DonnÃ©e ajoutÃ©e au buffer d'inspiration (${this.inputBuffer.length} en attente)`);
    return { queued: true, position: this.inputBuffer.length };
  },
  
  /**
   * RÃ©cupÃ¨re les donnÃ©es expirÃ©es
   * @returns {Array} DonnÃ©es traitÃ©es
   */
  harvestOutput() {
    const output = [...this.outputBuffer];
    this.outputBuffer = [];
    return output;
  },
  
  /**
   * Effectue un cycle complet manuellement
   * @param {any} data - DonnÃ©es Ã  traiter
   */
  async breatheOnce(data) {
    console.log(`
ğŸŒ¬ï¸ CYCLE DE RESPIRATION MANUEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `);
    
    // PrÃ©parer les donnÃ©es
    this.inputBuffer.push(data);
    
    // Inspiration
    this.currentPhase = "PURAKA";
    this.executePhase("PURAKA");
    await this.wait(100);
    
    // RÃ©tention
    this.currentPhase = "KUMBHAKA";
    this.executePhase("KUMBHAKA");
    await this.wait(100);
    
    // Expiration
    this.currentPhase = "RECHAKA";
    this.executePhase("RECHAKA");
    await this.wait(100);
    
    // Pause
    this.currentPhase = "SHUNYAKA";
    this.executePhase("SHUNYAKA");
    
    this.cycleCount++;
    
    // RÃ©cupÃ©rer le rÃ©sultat
    const output = this.harvestOutput();
    
    console.log(`
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    âœ… Cycle complet â€” ${output.length} rÃ©sultat(s)
    `);
    
    return output.length > 0 ? output[0] : null;
  },
  
  /**
   * Utilitaire d'attente
   */
  wait(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  },
  
  /**
   * Retourne l'Ã©tat actuel
   */
  getStatus() {
    const phaseInfo = PRANA_CONSTANTS.phases[this.currentPhase];
    
    return {
      currentPhase: this.currentPhase,
      phaseName: phaseInfo?.name,
      phaseAction: phaseInfo?.action,
      cycleCount: this.cycleCount,
      isBreathing: this.isBreathing,
      buffers: {
        input: this.inputBuffer.length,
        processing: this.processingBuffer.length,
        output: this.outputBuffer.length
      },
      stats: this.stats
    };
  },
  
  /**
   * Affiche la respiration visuellement
   */
  visualize() {
    const phases = ["PURAKA", "KUMBHAKA", "RECHAKA", "SHUNYAKA"];
    const symbols = {
      PURAKA: "â†‘ INSPIRATION",
      KUMBHAKA: "â—† RÃ‰TENTION",
      RECHAKA: "â†“ EXPIRATION",
      SHUNYAKA: "â—‹ PAUSE"
    };
    
    let viz = `
ğŸŒ¬ï¸ CYCLE PRANA â€” Ã‰TAT ACTUEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;
    
    for (const phase of phases) {
      const isCurrent = phase === this.currentPhase;
      const marker = isCurrent ? "â–¶" : " ";
      const symbol = symbols[phase];
      viz += `   ${marker} ${symbol}\n`;
    }
    
    viz += `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Cycle: ${this.cycleCount} | Phase: ${this.currentPhase}
`;
    
    return viz;
  },
  
  /**
   * RÃ©initialise le systÃ¨me
   */
  reset() {
    this.stopBreathing();
    this.currentPhase = "SHUNYAKA";
    this.cycleCount = 0;
    this.inputBuffer = [];
    this.processingBuffer = [];
    this.outputBuffer = [];
    this.stats = {
      totalCycles: 0,
      dataInhaled: 0,
      dataExhaled: 0,
      avgProcessingTime: 0
    };
    
    console.log("ğŸŒ¬ï¸ Prana Cycle rÃ©initialisÃ©");
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT PAR DÃ‰FAUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default {
  PRANA_CONSTANTS,
  PranaCycle
};
