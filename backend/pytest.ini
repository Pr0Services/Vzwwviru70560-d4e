# ═══════════════════════════════════════════════════════════════════════════════
# CHE·NU™ V76 — PYTEST CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
# Agent A - Phase A1: Test Framework Setup
# Date: 8 Janvier 2026
# Objectif: Infrastructure de tests robuste pour atteindre 85% coverage
# ═══════════════════════════════════════════════════════════════════════════════

[pytest]
# ─────────────────────────────────────────────────────────────────────────────
# CHEMINS ET DÉCOUVERTE
# ─────────────────────────────────────────────────────────────────────────────
testpaths = tests
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# ─────────────────────────────────────────────────────────────────────────────
# OPTIONS PAR DÉFAUT
# ─────────────────────────────────────────────────────────────────────────────
addopts = 
    -v
    --strict-markers
    --strict-config
    -ra
    --tb=short
    --color=yes
    --code-highlight=yes
    --show-capture=no
    -p no:warnings
    --durations=10
    --durations-min=1.0

# ─────────────────────────────────────────────────────────────────────────────
# COVERAGE (pytest-cov)
# ─────────────────────────────────────────────────────────────────────────────
# Utiliser: pytest --cov=app --cov-report=html --cov-report=term-missing

# ─────────────────────────────────────────────────────────────────────────────
# MARKERS PERSONNALISÉS CHE·NU
# ─────────────────────────────────────────────────────────────────────────────
markers =
    # Tests par type
    unit: Tests unitaires isolés (fast)
    integration: Tests d'intégration (medium)
    e2e: Tests end-to-end (slow)
    
    # Tests par priorité
    critical: Tests critiques (toujours exécuter)
    p0: Priorité 0 - Bloquant
    p1: Priorité 1 - Important
    p2: Priorité 2 - Nice to have
    
    # Tests R&D Compliance (7 règles)
    rd_rule_1: Rule #1 - Human Sovereignty (checkpoints)
    rd_rule_2: Rule #2 - Autonomy Isolation (sandbox)
    rd_rule_3: Rule #3 - Sphere/Identity Boundary (HTTP 403)
    rd_rule_4: Rule #4 - My Team Restrictions (no AI-to-AI)
    rd_rule_5: Rule #5 - Social No Ranking (chronological)
    rd_rule_6: Rule #6 - Module Traceability (created_by, created_at)
    rd_rule_7: Rule #7 - R&D Continuity
    
    # Tests par domaine
    governance: Tests de gouvernance
    threads: Tests des threads
    agents: Tests du système d'agents
    decisions: Tests des décisions/checkpoints
    identity: Tests identity boundary
    spheres: Tests des 9 sphères
    nova: Tests de Nova (assistant)
    xr: Tests XR (read-only)
    
    # Tests négatifs (IMPORTANT - Philosophie Agent A)
    negative: Tests qui DOIVENT échouer (security, boundaries)
    edge_case: Tests de cas limites
    race_condition: Tests de race conditions
    
    # Phase A3 - Security Tests
    security: Tests de sécurité (injection, XSS, auth)
    injection: Tests d'injection SQL/NoSQL
    xss: Tests de prévention XSS
    auth: Tests d'authentification
    
    # Phase A3 - Performance Tests
    slow: Tests lents (>5s)
    benchmark: Tests de benchmark
    performance: Tests de performance et latence
    throughput: Tests de débit
    scalability: Tests de scalabilité
    
    # Phase A3 - Concurrency Tests
    concurrency: Tests de concurrence
    stress: Tests de stress haute charge
    deadlock: Tests de prévention deadlock
    
    # Tests avec dépendances externes
    database: Requiert une base de données
    redis: Requiert Redis
    external_api: Requiert API externe (mock par défaut)

# ─────────────────────────────────────────────────────────────────────────────
# ASYNC
# ─────────────────────────────────────────────────────────────────────────────
asyncio_mode = auto

# ─────────────────────────────────────────────────────────────────────────────
# LOGGING
# ─────────────────────────────────────────────────────────────────────────────
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s
log_cli_date_format = %H:%M:%S

log_file = tests/logs/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] %(name)s (%(filename)s:%(lineno)s): %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# ─────────────────────────────────────────────────────────────────────────────
# FILTRES
# ─────────────────────────────────────────────────────────────────────────────
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    error::UserWarning

# ─────────────────────────────────────────────────────────────────────────────
# TIMEOUTS
# ─────────────────────────────────────────────────────────────────────────────
timeout = 30
timeout_method = thread

# ─────────────────────────────────────════════════════════════════════════════
# NOTES D'UTILISATION
# ═══════════════════════════════════════════════════════════════════════════════
#
# Commandes utiles:
#
# Tous les tests:
#   pytest
#
# Tests unitaires seulement:
#   pytest -m unit
#
# Tests R&D compliance:
#   pytest -m "rd_rule_1 or rd_rule_2 or rd_rule_3 or rd_rule_4 or rd_rule_5 or rd_rule_6 or rd_rule_7"
#
# Tests négatifs (ce qui DOIT échouer):
#   pytest -m negative
#
# Tests critiques seulement:
#   pytest -m critical
#
# Avec coverage:
#   pytest --cov=app --cov-report=html --cov-report=term-missing
#
# Tests parallèles (nécessite pytest-xdist):
#   pytest -n auto
#
# ═══════════════════════════════════════════════════════════════════════════════
